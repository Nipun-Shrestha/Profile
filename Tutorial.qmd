---
title: "Tutorial"
code-fold: true
bibliography: references.bib
author: 
  - name: Dr Nipun Shrestha
    url: https://ctc.usyd.edu.au/about-us/our-people/academics-research-fellows/dr-nipun-shrestha/
    orcid: 0000-0003-3542-8130
    degrees: 
      - MBBS
      - MPH
      - PhD
google-scholar: true
lightbox: true
engine: knitr
filters:
  - webr
  - shinylive
---

# Meta-analysis in R

Cord clamping in pre-term babies data from the recently published individual participant data meta analysis is used for this task.[@seidler2023]

::: callout-note
Note that only summary level data is used for this tutorial.
:::

::: panel-tabset
#### Loading Packages

```{r library, warning = FALSE, message = FALSE}
library(tidyverse)
library(lubridate)
library(dplyr)
library(metafor)
library (readxl)
```

#### Loading Data

Loading data {this data is located in github repository. https://github.com/Nipun-Shrestha/Profile_page/blob/main/Icomp.xlsx}

```{r data, warning = FALSE, message = FALSE}
Icomp <- read_excel("Icomp.xlsx")
```
:::

## Calculate log odd ratios and corresponding sampling variances

```{r calculate odds ratio}
dat <- escalc(measure="OR", ai=Icomp$`n_event DCC`, bi=Icomp$n_non_event_DCC, ci=Icomp$`n_event ICC`, di=Icomp$n_non_event_ICC, slab =paste(Icomp$studyid), data=Icomp)
```

## Random-effects model (using log odd ratios and variances as input)

```{r model}
res <- rma(dat$yi, dat$vi, data=dat, method="FE")
```

## Helper function

```{r helper function}
mlabfun <- function(text, res) {
   list(bquote(paste(.(text),
      " (Q = ", .(formatC(res$QE, digits=2, format="f")),
      ", df = ", .(res$k - res$p),
      ", p ", .(metafor:::.pval(res$QEp, digits=2, showeq=TRUE, sep=" ")), "; ",
      I^2, " = ", .(formatC(res$I2, digits=1, format="f")), "%, ",
      tau^2, " = ", .(formatC(res$tau2, digits=2, format="f")), ")")))}
```

## Forest plot

```{r fig.height= 10, fig.width=17, dpi=400}


data_height <- nrow(dat)

#change the left bound after you have run the forest plot once
left_bound <- -8.5
#change the right bound after you have run the forest plot once
right_bound <-4

sav <- forest(res, header=TRUE, xlim=c(left_bound,right_bound), at=log(c(0.5, 0.25, 1, 4)), atransf=exp, ylim=c(-1, (data_height +3)), xlab ="Odds ratio", mlab=mlabfun("RE Model for All Studies", res), ilab=cbind(Icomp$`n_event DCC`, N_DCC, Icomp$`n_event ICC`, Icomp$N_ICC), ilab.xpos=seq(-5.8,-3.8, length = 4), slab=paste(dat$studyid), psize=1)
text(left_bound, data_height+3.5, pos=4, cex=1.3, c("DCC vs ICC Meta-analysis - Death before discharge"), font = 4)
  
text(sav$ilab.xpos, (data_height+2), pos=1, c("Events","Total","Events","Total"), cex = 1.1, font =3)
  
text(c(mean(sav$ilab.xpos[1:2]),mean(sav$ilab.xpos[3:4])), data_height+3, c("DCC","ICC"), pos=1, cex=1.3)

text(c(log(0.15),log(4)), -0.3, pos=1, c("Favours DCC", "Favours ICC"), cex=1.3)
```

# Age-standardized DALYs rate of cardiovascular disease per 100,000 population from 2001 to 2021 in South Asia by country’s GDP/capita (US\$)

The GDP per capita (inflation-adjusted) are plotted in x-axis and corresponding values of gender difference in age-standardized cardiovascular disease (CVD) rates (male rates minus female rates) are plotted in y-axis. The size of bubble corresponds to the size of the population of the country. The definition of cardiovascular disease includes all eleven CVD types and is described [elsewhere](https://www.healthdata.org/research-analysis/gbd "GBD"). The data on cardiovascular disease rates were obtained from the [Global Burden of Disease](https://www.healthdata.org/research-analysis/gbd "GBD") and GDP per capita from [World Bank.](https://data.worldbank.org/indicator/NY.GDP.PCAP.CD?end=2022&locations=8S&start=2001)

```{r dpi=400}
library(tidyverse)
library(ggplot2)
library(gganimate)
theme_set(theme_bw())
library("gifski")
load("~/GitHub/Profile/GBD.Rdata")
dat1 <- dat1 %>% filter(measure =="DALYs (Disability-Adjusted Life Years)") 


p <- ggplot(
dat1,
aes(x = income, y=val, size = Population, colour = Country)
) +
geom_point(show.legend = TRUE, alpha = 1) +
scale_color_viridis_d() +
scale_size(range = c(2, 12)) +
scale_x_log10() +
labs(x = "Income per person (GDP/capita PPPS inflation-adjusted", y = "Age-standardized DALYs rate per 100,000") +
  facet_wrap(~sex)


R <- p + transition_time(year) +
labs(title = "Year: {frame_time}") +
shadow_mark(alpha = 2, size = 2) +
  facet_wrap(~sex)
R
#animate(R, height=400, width=800, renderer=gifski_renderer())

```
